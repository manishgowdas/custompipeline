name: Deploy EKS Addons

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment (dev, stage, prod)"
        required: true
        default: "dev"
        type: choice
        options: [dev, stage, prod]
      addon:
        description: "Addon to deploy (alb, metric-server, argocd, prometheus, grafana)"
        required: true
        default: "alb"
        type: choice
        options: [alb, metric-server, argocd, prometheus, grafana]
      vpc_id:
        description: "VPC ID (required for ALB controller)"
        required: false
        default: ""
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Set AWS Role ARN
      run: |
        echo "AWS_ACCOUNT_ID=${{ secrets.AWS_ACCOUNT_ID }}" >> $GITHUB_ENV
        echo "ROLE_TO_ASSUME=arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/GitHubActionsEKSRole" >> $GITHUB_ENV
        echo "AWS_REGION=ap-northeast-2" >> $GITHUB_ENV
        echo "VPC_ID=${{ github.event.inputs.vpc_id }}" >> $GITHUB_ENV

    - name: Set cluster name
      run: |
        case "${{ github.event.inputs.environment }}" in
          dev)   echo "CLUSTER_NAME=mycluster" >> $GITHUB_ENV ;;
          stage) echo "CLUSTER_NAME=mycluster" >> $GITHUB_ENV ;;
          prod)  echo "CLUSTER_NAME=mycluster" >> $GITHUB_ENV ;;
        esac

    - name: Debug info
      run: |
        echo "AWS_ACCOUNT_ID=$AWS_ACCOUNT_ID"
        echo "ROLE_TO_ASSUME=$ROLE_TO_ASSUME"
        echo "Region=$AWS_REGION"
        echo "Cluster=$CLUSTER_NAME"
        echo "VPC_ID=$VPC_ID"

    - name: Configure AWS credentials via OIDC
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ env.ROLE_TO_ASSUME }}
        aws-region: ${{ env.AWS_REGION }}
        audience: sts.amazonaws.com

    - name: Setup kubectl
      uses: azure/setup-kubectl@v3

    - name: Setup helm
      uses: azure/setup-helm@v3

    - name: Update kubeconfig for EKS
      run: aws eks update-kubeconfig --name $CLUSTER_NAME --region $AWS_REGION

    # --- Metrics Server ---
    - name: Deploy Metrics Server
      if: ${{ github.event.inputs.addon == 'metric-server' }}
      run: |
        if helm status metrics-server -n kube-system >/dev/null 2>&1; then
          echo "Metrics Server already installed, skipping..."
        else
          helm repo add metrics-server https://kubernetes-sigs.github.io/metrics-server/
          helm upgrade --install metrics-server metrics-server/metrics-server \
            --namespace kube-system --create-namespace
        fi

    # --- AWS Load Balancer Controller ---
    - name: Ensure IAM Policy
      if: ${{ github.event.inputs.addon == 'alb' }}
      run: |
        POLICY_ARN="arn:aws:iam::$AWS_ACCOUNT_ID:policy/AWSLoadBalancerControllerIAMPolicy"
        if aws iam get-policy --policy-arn $POLICY_ARN >/dev/null 2>&1; then
          echo "Policy already exists, skipping..."
        else
          curl -o iam_policy.json https://raw.githubusercontent.com/kubernetes-sigs/aws-load-balancer-controller/main/docs/install/iam_policy.json
          aws iam create-policy \
            --policy-name AWSLoadBalancerControllerIAMPolicy \
            --policy-document file://iam_policy.json
        fi

    - name: Ensure IAM Role
      if: ${{ github.event.inputs.addon == 'alb' }}
      run: |
        if aws iam get-role --role-name AWSLoadBalancerControllerRole >/dev/null 2>&1; then
          echo "Role already exists, skipping..."
        else
          OIDC_PROVIDER=$(aws eks describe-cluster --name $CLUSTER_NAME --region $AWS_REGION \
            --query "cluster.identity.oidc.issuer" --output text | sed -e "s/^https:\/\///")
          cat > trust.json <<EOF
          {
            "Version": "2012-10-17",
            "Statement": [
              {
                "Effect": "Allow",
                "Principal": {
                  "Federated": "arn:aws:iam::$AWS_ACCOUNT_ID:oidc-provider/${OIDC_PROVIDER}"
                },
                "Action": "sts:AssumeRoleWithWebIdentity",
                "Condition": {
                  "StringEquals": {
                    "${OIDC_PROVIDER}:sub": "system:serviceaccount:kube-system:aws-load-balancer-controller"
                  }
                }
              }
            ]
          }
          EOF
          aws iam create-role \
            --role-name AWSLoadBalancerControllerRole \
            --assume-role-policy-document file://trust.json
          aws iam attach-role-policy \
            --role-name AWSLoadBalancerControllerRole \
            --policy-arn $POLICY_ARN
        fi

    - name: Ensure Service Account
      if: ${{ github.event.inputs.addon == 'alb' }}
      run: |
        if kubectl get sa aws-load-balancer-controller -n kube-system >/dev/null 2>&1; then
          echo "ServiceAccount already exists, skipping..."
        else
          kubectl create serviceaccount aws-load-balancer-controller -n kube-system
        fi
        kubectl annotate serviceaccount aws-load-balancer-controller \
          -n kube-system \
          eks.amazonaws.com/role-arn=arn:aws:iam::$AWS_ACCOUNT_ID:role/AWSLoadBalancerControllerRole --overwrite

    - name: Deploy AWS Load Balancer Controller
      if: ${{ github.event.inputs.addon == 'alb' }}
      run: |
        if helm status aws-load-balancer-controller -n kube-system >/dev/null 2>&1; then
          echo "AWS Load Balancer Controller already installed, skipping..."
        else
          helm repo add eks https://aws.github.io/eks-charts
          helm upgrade --install aws-load-balancer-controller eks/aws-load-balancer-controller \
            --namespace kube-system --create-namespace \
            --set clusterName=$CLUSTER_NAME \
            --set serviceAccount.create=false \
            --set serviceAccount.name=aws-load-balancer-controller \
            --set vpcId=$VPC_ID
        fi

    # --- ArgoCD ---
    - name: Deploy ArgoCD
      if: ${{ github.event.inputs.addon == 'argocd' }}
      run: |
        if helm status argocd -n argocd >/dev/null 2>&1; then
          echo "ArgoCD already installed, skipping..."
        else
          helm repo add argo https://argoproj.github.io/argo-helm
          helm upgrade --install argocd argo/argo-cd \
            --namespace argocd --create-namespace
        fi

    # --- Prometheus ---
    - name: Deploy Prometheus
      if: ${{ github.event.inputs.addon == 'prometheus' }}
      run: |
        if helm status prometheus -n monitoring >/dev/null 2>&1; then
          echo "Prometheus already installed, skipping..."
        else
          helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
          helm repo update
          helm upgrade --install prometheus prometheus-community/prometheus \
            --namespace monitoring --create-namespace \
            --set server.persistentVolume.enabled=true \
            --set server.persistentVolume.storageClass=gp2 \
            --set server.persistentVolume.size=10Gi
        fi

    # --- Grafana ---
    - name: Deploy Grafana
      if: ${{ github.event.inputs.addon == 'grafana' }}
      run: |
        if helm status grafana -n monitoring >/dev/null 2>&1; then
          echo "Grafana already installed, skipping..."
        else
          helm repo add grafana https://grafana.github.io/helm-charts
          helm repo update
          helm upgrade --install grafana grafana/grafana \
            --namespace monitoring --create-namespace
        fi
