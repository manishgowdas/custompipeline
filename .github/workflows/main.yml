name: Deploy EKS Addons

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment (dev, stage, prod)"
        required: true
        default: "dev"
        type: choice
        options:
          - dev
          - stage
          - prod
      addon:
        description: "Addon to deploy (alb, metric-server, argocd)"
        required: true
        default: "alb"
        type: choice
        options:
          - alb
          - metric-server
          - argocd
          - prometheus
          - grafana

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    # Single account ID from GitHub secret/variable
    - name: Set AWS Role ARN
      run: |
        echo "AWS_ACCOUNT_ID=${{ secrets.AWS_ACCOUNT_ID }}" >> $GITHUB_ENV
        echo "ROLE_TO_ASSUME=arn:aws:iam::${AWS_ACCOUNT_ID}:role/GitHubActionsEKSRole" >> $GITHUB_ENV
        echo "AWS_REGION=ap-south-1" >> $GITHUB_ENV

    - name: Configure AWS credentials via OIDC
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ env.ROLE_TO_ASSUME }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Setup kubectl
      uses: azure/setup-kubectl@v3

    - name: Setup helm
      uses: azure/setup-helm@v3

    # Map environment input to cluster name
    - name: Set cluster name
      run: |
        case "${{ github.event.inputs.environment }}" in
          dev)   echo "CLUSTER_NAME=dev-eks-cluster"   >> $GITHUB_ENV ;;
          stage) echo "CLUSTER_NAME=stage-eks-cluster" >> $GITHUB_ENV ;;
          prod)  echo "CLUSTER_NAME=prod-eks-cluster"  >> $GITHUB_ENV ;;
        esac

    - name: Update kubeconfig for EKS
      run: aws eks update-kubeconfig --name $CLUSTER_NAME --region $AWS_REGION

    # --- Conditional: Metrics Server ---
    - name: Deploy Metrics Server
      if: ${{ github.event.inputs.addon == 'metric-server' }}
      run: |
        helm repo add metrics-server https://kubernetes-sigs.github.io/metrics-server/
        helm upgrade --install metrics-server metrics-server/metrics-server \
          --namespace kube-system --create-namespace

    # --- Conditional: AWS Load Balancer Controller ---
    - name: Ensure IAM Policy
      if: ${{ github.event.inputs.addon == 'alb' }}
      run: |
        curl -o iam_policy.json https://raw.githubusercontent.com/kubernetes-sigs/aws-load-balancer-controller/main/docs/install/iam_policy.json
        POLICY_ARN="arn:aws:iam::${AWS_ACCOUNT_ID}:policy/AWSLoadBalancerControllerIAMPolicy"
        if ! aws iam get-policy --policy-arn $POLICY_ARN >/dev/null 2>&1; then
          aws iam create-policy \
            --policy-name AWSLoadBalancerControllerIAMPolicy \
            --policy-document file://iam_policy.json
        else
          echo "Policy already exists, skipping..."
        fi

    - name: Ensure IAM Role
      if: ${{ github.event.inputs.addon == 'alb' }}
      run: |
        OIDC_PROVIDER=$(aws eks describe-cluster --name $CLUSTER_NAME --region $AWS_REGION \
          --query "cluster.identity.oidc.issuer" --output text | sed -e "s/^https:\/\///")
        cat > trust.json <<EOF
        {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Federated": "arn:aws:iam::${AWS_ACCOUNT_ID}:oidc-provider/${OIDC_PROVIDER}"
              },
              "Action": "sts:AssumeRoleWithWebIdentity",
              "Condition": {
                "StringEquals": {
                  "${OIDC_PROVIDER}:sub": "system:serviceaccount:kube-system:aws-load-balancer-controller"
                }
              }
            }
          ]
        }
        EOF
        if ! aws iam get-role --role-name AWSLoadBalancerControllerRole >/dev/null 2>&1; then
          aws iam create-role \
            --role-name AWSLoadBalancerControllerRole \
            --assume-role-policy-document file://trust.json
          aws iam attach-role-policy \
            --role-name AWSLoadBalancerControllerRole \
            --policy-arn arn:aws:iam::${AWS_ACCOUNT_ID}:policy/AWSLoadBalancerControllerIAMPolicy
        else
          echo "Role already exists, skipping..."
        fi

    - name: Ensure Service Account
      if: ${{ github.event.inputs.addon == 'alb' }}
      run: |
        kubectl get sa aws-load-balancer-controller -n kube-system >/dev/null 2>&1 || \
          kubectl create serviceaccount aws-load-balancer-controller -n kube-system
        kubectl annotate serviceaccount aws-load-balancer-controller \
          -n kube-system \
          eks.amazonaws.com/role-arn=arn:aws:iam::${AWS_ACCOUNT_ID}:role/AWSLoadBalancerControllerRole --overwrite

    - name: Deploy AWS Load Balancer Controller
      if: ${{ github.event.inputs.addon == 'alb' }}
      run: |
        helm repo add eks https://aws.github.io/eks-charts
        helm upgrade --install aws-load-balancer-controller eks/aws-load-balancer-controller \
          --namespace kube-system --create-namespace \
          --set clusterName=$CLUSTER_NAME \
          --set serviceAccount.create=false \
          --set serviceAccount.name=aws-load-balancer-controller

    # --- Conditional: ArgoCD ---
    - name: Deploy ArgoCD
      if: ${{ github.event.inputs.addon == 'argocd' }}
      run: |
        helm repo add argo https://argoproj.github.io/argo-helm
        helm upgrade --install argocd argo/argo-cd \
          --namespace argocd --create-namespace

    # --- Conditional: Prometheus ---
    - name: Deploy Prometheus
      if: ${{ github.event.inputs.addon == 'prometheus' }}
      run: |
        helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
        helm repo update
        helm upgrade --install prometheus prometheus-community/prometheus \
          --namespace monitoring --create-namespace \
          --set alertmanager.persistentVolume.enabled=true \
          --set alertmanager.persistentVolume.storageClass=gp2 \
          --set alertmanager.persistentVolume.size=5Gi \
          --set server.persistentVolume.enabled=true \
          --set server.persistentVolume.storageClass=gp2 \
          --set server.persistentVolume.size=10Gi

    # --- Conditional: Grafana ---
    - name: Deploy Grafana
      if: ${{ github.event.inputs.addon == 'grafana' }}
      run: |
        helm repo add grafana https://grafana.github.io/helm-charts
        helm repo update
        helm upgrade --install grafana grafana/grafana \
          --namespace
